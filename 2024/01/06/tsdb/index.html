<!DOCTYPE html><html lang="zh-CN" id="theme-light-mode"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Yourname"><title>时序数据库中的聚合计算：加速洞察与优化性能(上) · 陈sir爱狂扁</title><meta name="description" content="1. 引言在当今数据驱动的世界中，时序数据库（TSDB）已成为处理和分析时间序列数据的关键工具。随着物联网（IoT）设备的激增和实时数据流的爆炸性增长，对高效处理和分析这些数据的需求日益迫切。聚合计算，作为TSDB的一个核心功能，为用户在海量时序数据中快速提取有价值信息提供了可能。
2. 名词解释T"><meta name="keywords" content="Blog,博客,Hexo"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="shortcut icon" type="image/x-icon" href="/images/favicon.webp"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/insight.css"><link rel="stylesheet" href="/css/search.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 6.3.0"></head><body><div class="page-top animated fadeInDown"><div class="nav"><li> <a href="/">Home</a></li><li> <a href="/archives">Archives</a></li><li> <a href="/tags">Tags</a></li><li> <a href="/about">About</a></li><li> <a href="/links">Links</a></li></div><div class="information"><div class="nav_right_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li><li><a class="fa fa-search" onclick="openWindow();"></a></li><li><a class="fa fa-sun-o" onclick="darkLightToggle();"></a></li></div><div class="avatar"><img src="/images/logo.webp"></div></div></div><div class="sidebar animated fadeInDown"><div class="sidebar-top"><div class="logo-title"><div class="title"><img src="/images/logo@2x.webp" style="width:220px;" alt="favicon"><h3 title=""><a href="/">陈sir爱狂扁</a></h3><div class="description"><p>A simple and beautiful blog</p></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/Lhcfl"><i class="fa fa-github"></i></a></li><li><a href="mailto:yourname@example.com"><i class="fa fa-envelope"></i></a></li></ul></div></div><div class="footer"><div class="p"> <span> 全站CC-BY-SA-3.0 </span><i class="fa fa-star"></i><span> Yourname</span></div><div class="by_farbox"><span>Powered by </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a><span> & </span><a href="https://github.com/Lhcfl/hexo-theme-anatolo" target="_blank">Anatolo </a></div><div class="beian"></div></div></div><div class="main"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>时序数据库中的聚合计算：加速洞察与优化性能(上)</a></h3></div><div class="post-content"><p><h1 id="1-引言"><a href="#1-引言" class="headerlink" title="1. 引言"></a>1. 引言</h1><p>在当今数据驱动的世界中，时序数据库（TSDB）已成为处理和分析时间序列数据的关键工具。随着物联网（IoT）设备的激增和实时数据流的爆炸性增长，对高效处理和分析这些数据的需求日益迫切。聚合计算，作为TSDB的一个核心功能，为用户在海量时序数据中快速提取有价值信息提供了可能。</p>
<h1 id="2-名词解释"><a href="#2-名词解释" class="headerlink" title="2. 名词解释"></a>2. 名词解释</h1><p><strong>TSDB</strong>: Time Series Database，时序数据库，用于保存时间序列（按时间顺序变化）的海量数据。<br><strong>metric</strong>: 度量，如发动机的温度、转速等。metric相当于关系型数据库中的table。<br><strong>timestamp</strong>: 时间戳，格林威治时间1970年01月01日00时00分00秒(北京时间1970年01月01日08时00分00秒)起至现在的总毫秒数。<br><strong>field</strong>: 度量下的不同字段，譬如位置这个度量下可以有经度和纬度两个字段。每个字段有相应的数值，如56°C、1000r&#x2F;s等（实际中不带单位）。<br><strong>tag</strong>: 标签，或附加属性，一个tag是一个key-value对，用于提供额外的信息，如“型号&#x3D;ABC123”、“出厂编号&#x3D;1234567890”等。<br><strong>row</strong>: 数据行，“一个metric + m个field + n个tag + 一个timestamp”定义了一个数据行，一个row由m个data point组成。<br><strong>data point</strong>: 数据点，“一个metric + 一个field + n个tag + 一个timestamp”唯一定义了一个数据点。<br><strong>time series</strong>: 时间序列，“一个metric + 一个field + n个tag”唯一定义了一个时间序列，一个time series相当于一个设备上的一个传感器收集到的所有数据。<br><strong>group</strong>: 分组，可以按tag对data point进行分组。<br><strong>aggregator</strong>: 聚合函数，可以对一段时间的data point做聚合，如每10分钟的和值、平均值、最大值、最小值等。<br><strong>database</strong>: 数据库，一个用户可以有多个database，一个database可以写入多个metric的data point。metric相当于table，timestamp + 所有tag相当于primary key。<br>metric、timestamp、field、tag、row、data point、time series的关系如下图所示：<br><img src="/../images/img_tsdb.png" alt="img_tsdb.png"></p>
<h1 id="3-架构设计"><a href="#3-架构设计" class="headerlink" title="3. 架构设计"></a>3. 架构设计</h1><h2 id="3-1总体架构设计"><a href="#3-1总体架构设计" class="headerlink" title="3.1总体架构设计"></a>3.1总体架构设计</h2><p><img src="/../images/img_struct.png" alt="img_stauct.png"><br>TSDB内部分为在线和离线两个部分。<br>在线部分主要是负责数据的实时读写，分为4层：</p>
<ol>
<li>接入层，又分为HTTP接入层和MySQL接入层，HTTP接入层负责提供对外的在线写入和查询接口，MySQL接入层提供基于MySQL的二进制协议的SQL查询接口，两者都提供认证鉴权和各种quota限制。</li>
<li>索引层，负责根据metric和tag等字段对time series建立索引，实现time series的快速检索。</li>
<li>分布式SQL层，负责将大数据量的SQL查询分拆成DAG（有向无环图）任务，在多个机器上并行完成，最后在接入层返回最终结果。</li>
<li>数据层，又分为实时数据层和历史数据层，实时数据层负责存储最近写入的数据，当数据写入超过一天后，会进行压缩并写入历史数据层，最近半年为热数据，半年以上为冷数据，超过半年的热数据会自动迁移到冷数据存储。<br>离线部分主要是负责后台管理，如database的创建删除、导入导出等。</li>
</ol>
<h2 id="3-2-在线部分架构"><a href="#3-2-在线部分架构" class="headerlink" title="3.2 在线部分架构"></a>3.2 在线部分架构</h2><p><img src="/../images/img_online.png" alt="img_online.png"></p>
<h3 id="3-2-1-接入层"><a href="#3-2-1-接入层" class="headerlink" title="3.2.1 接入层"></a>3.2.1 接入层</h3><p><strong>BaiduGateWay</strong>:  提供负载均衡的能力<br><strong>data api</strong>: 为用户提供在线的数据写入和查询服务，<br>写入时，data api将索引写入elasticsearch，同时将数据写入cassandra；查询时，data api先从elasticsearch查询索引，然后将查询拆分成DAG任务，并通过presto master申请资源，再发送给presto worker，presto worker进行分布式并行计算，得到最终的查询结果。<br>data api提供短连接的Restful API给用户调用。<br><strong>mysql adaptor</strong>: 为用户提供mysql二进制协议的长连接接入，从而使用户可以通过mysql jdbc&#x2F;odbc driver连接TSDB并进行SQL查询。查询路径与data api类似。</p>
<h3 id="3-2-2-索引层"><a href="#3-2-2-索引层" class="headerlink" title="3.2.2 索引层"></a>3.2.2 索引层</h3><p><strong>elasticsearch</strong><br>我们对时序数据的metric、field、tag建立索引，从而保证这些字段能被快速的检索，同时还能支持地理位置的检索。<br>elasticsearch用于存储这些索引，data api在写入数据的同时，需要将索引写入elasticsearch；在查询数据之前，需要先从elasticsearch查询索引。<br>快速了解elasticsearch：<a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/documents-indices.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/documents-indices.html</a></p>
<h3 id="3-2-3-分布式SQL层"><a href="#3-2-3-分布式SQL层" class="headerlink" title="3.2.3 分布式SQL层"></a>3.2.3 分布式SQL层</h3><p><strong>presto master</strong>: 负责presto worker的发现，管理presto worker的资源，对任务进行调度，防止presto worker过载。<br>presto master是一个单点服务，但有一个standby做HA，primary挂掉之后，standby会成为新的primary，并从presto worker获取并恢复目前的资源分配状态，因此primary和standby之间不需要做状态同步。<br><strong>presto driver</strong>: 是集成在data api和mysql adaptor中的模块，负责对SQL进行解析、优化、DAG生成，然后调用presto master进行资源的分配，最后调用presto worker进行分布式并行计算。<br><strong>presto worker</strong>: 负责真正的计算任务的执行，由于执行任务是DAG的形式，所以presto worker之间存在互相访问。<br>为了减少网络开销，可以将presto worker和cassandra&#x2F;hbase部署在同一个机器上，presto master在分配presto worker时首先考虑数据的本地化。</p>
<h3 id="3-2-3-数据层"><a href="#3-2-3-数据层" class="headerlink" title="3.2.3 数据层"></a>3.2.3 数据层</h3><p><strong>cassandra</strong><br>最近写入的数据会首先写入cassandra，cassandra中存储的是最近1天写入的数据，主要是利用cassandra吞吐量大、延迟低、高可用的特性。<br>快速了解cassandra：什么是Cassandra？<br><strong>hbase</strong><br>数据写入cassandra一天之后，会从cassandra读出并进行压缩，再写入ssd机器上的hbase。这里使用hbase是利用hbase可运维性好的特性。<br>在ssd集群的hbase里超过半年的数据，会被迁移到sata集群的hbase，并进行ec编码，使副本数从3下降到1.5，同时sata的成本也比ssd低一个数量级，从而大大降低了历史数据的存储成本。<br>快速了解hbase：我终于看懂了HBase，太不容易了…</p>
<h2 id="3-3-离线部分架构"><a href="#3-3-离线部分架构" class="headerlink" title="3.3 离线部分架构"></a>3.3 离线部分架构</h2><p>主要是涉及后台管理相关，跳过不谈</p>
</p></div><div class="post-footer"><div class="tip">本文采用CC-BY-SA-3.0协议，转载请注明出处<br>Author: Yourname</div><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-01-06</span><i class="fa fa-tag"></i><a class="tag" href="/tags/时序数据库TSDB/" title="时序数据库TSDB">时序数据库TSDB </a><span class="leancloud_visitors"></span><span>About 1738 words, 5 min 47 sec  read</span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/intent/tweet?text=I%20have%20found%20a%20great%20blog.%0A%0A%E9%99%88sir%E7%88%B1%E7%8B%82%E6%89%81%20%C2%B7%20%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E8%81%9A%E5%90%88%E8%AE%A1%E7%AE%97%EF%BC%9A%E5%8A%A0%E9%80%9F%E6%B4%9E%E5%AF%9F%E4%B8%8E%E4%BC%98%E5%8C%96%E6%80%A7%E8%83%BD(%E4%B8%8A)%0Ahttps://cheny-alf.github.io/2024/01/06/tsdb/%0A"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/03/06/optimization/" title="记录一次接口优化过程">Previous</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2023/10/30/nsq-Source-code-analysis/" title="NSQD源码解析：执行入口分析与核心功能解释">Next</a></li></ul></div><script src="/js/visitors.js"></script></div></div></div></div><script src="/js/darkLightToggle.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script>(function(window){var INSIGHT_CONFIG={TRANSLATION:{POSTS:"Posts",PAGES:"Pages",CATEGORIES:"Categories",TAGS:"Tags",UNTITLED:"(Untitled)",},CONTENT_URL:"/content.json",};window.INSIGHT_CONFIG=INSIGHT_CONFIG})(window);</script><script src="/js/insight.js" defer></script><div class="searchbox ins-search"><div class="searchbox-container ins-search-container"><div class="searchbox-input-wrapper"><input class="searchbox-input ins-search-input" type="text" placeholder="Search..."><span class="searchbox-close"><a class="fa fa-times-circle" onclick="closeWindow();"></a></span></div><div class="searchbox-result-wrapper ins-section-wrapper"><div class="ins-section-container"><p>Seraching...</p></div></div></div></div></body></html>